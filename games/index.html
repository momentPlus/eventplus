<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Event Plus - المهرجان المتكامل</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@900&display=swap');

        body { 
            touch-action: none; 
            overflow: hidden; 
            user-select: none; 
            -webkit-user-select: none; 
            font-family: 'Tajawal', sans-serif;
            background-color: #0f0518;
        }
        
        /* --- المؤثرات البصرية --- */
        .bg-hero-container { position: absolute; inset: 0; z-index: -2; background-color: #0f0518; overflow: hidden; }
        .hero-orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5; animation: orbFloat 10s infinite ease-in-out alternate; }
        .orb-1 { top: -10%; left: -10%; width: 70vw; height: 70vw; background: radial-gradient(circle, #6d28d9 0%, transparent 70%); animation-duration: 12s; }
        .orb-2 { bottom: -20%; right: -10%; width: 60vw; height: 60vw; background: radial-gradient(circle, #1d4ed8 0%, transparent 70%); animation-duration: 15s; animation-delay: -5s; }
        
        @keyframes orbFloat { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(20px, 40px) scale(1.05); } }

        .glass-panel { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-input { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; color: white; text-align: center; }
        .glass-input:focus { background: rgba(0, 0, 0, 0.5); border-color: #a855f7; box-shadow: 0 0 15px rgba(168, 85, 247, 0.2); outline: none; }

        .crt-scanline { background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 3px, 3px 100%; pointer-events: none; z-index: 50; position: absolute; inset: 0; opacity: 0.15; }
        
        .animate-slideUp { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .pulse-border { animation: pulseBorder 2s infinite; }
        @keyframes pulseBorder { 0% { border-color: rgba(168, 85, 247, 0.3); } 50% { border-color: rgba(168, 85, 247, 0.8); box-shadow: 0 0 15px rgba(168, 85, 247, 0.2); } 100% { border-color: rgba(168, 85, 247, 0.3); } }

        /* Custom Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }

        /* Timer Bar Animation */
        @keyframes timerShrink { from { width: 100%; } to { width: 0%; } }
        .timer-bar { height: 4px; background: #ef4444; border-radius: 2px; }
        
        .font-brand { font-family: 'Montserrat', sans-serif; }
    </style>
</head>
<body class="bg-[#0f0518] text-white h-screen w-screen overflow-hidden">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- AUDIO SYSTEM ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const soundSettings = {
            sfx: true,
            music: true
        };

        const playTone = (freq, type, duration, vol = 0.1) => {
            if (!soundSettings.sfx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        };

        let bgmInterval = null;
        const startBgm = () => {
            if (bgmInterval) clearInterval(bgmInterval);
            if (!soundSettings.music) return;
            
            const notes = [261.63, 329.63, 392.00, 493.88, 523.25];
            bgmInterval = setInterval(() => {
                if (!soundSettings.music || audioCtx.state === 'suspended') return;
                const note = notes[Math.floor(Math.random() * notes.length)];
                
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(note / 2, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.02, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + 2);
            }, 3000);
        };

        const stopBgm = () => {
            if (bgmInterval) clearInterval(bgmInterval);
        };

        const SoundManager = {
            click: () => playTone(800, 'sine', 0.1, 0.1),
            correct: () => { playTone(1200, 'sine', 0.1, 0.1); setTimeout(() => playTone(1800, 'sine', 0.2, 0.1), 100); },
            wrong: () => { playTone(150, 'sawtooth', 0.3, 0.1); setTimeout(() => playTone(100, 'sawtooth', 0.3, 0.1), 150); },
            win: () => { 
                if (!soundSettings.sfx) return;
                [500, 600, 700, 800, 1000].forEach((f, i) => setTimeout(() => playTone(f, 'square', 0.1, 0.1), i * 100));
            },
            delete: () => { playTone(200, 'sawtooth', 0.2, 0.2); setTimeout(() => playTone(150, 'sawtooth', 0.4, 0.2), 200); },
            updateSettings: (newSfx, newMusic) => {
                soundSettings.sfx = newSfx;
                soundSettings.music = newMusic;
                if (newMusic) startBgm(); else stopBgm();
            }
        };

        // --- ICONS ---
        const Icon = ({ name, size = 24, className, ...props }) => {
            if (!window.lucide || !window.lucide.icons) return null;
            const iconData = window.lucide.icons[name];
            if (!iconData) return null;
            return React.createElement('svg', {
                xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round",
                className: className, ...props
            }, iconData.map((child, idx) => React.createElement(child[0], { key: idx, ...child[1] })));
        };

        // --- DIFFICULTY CONFIG ---
        const DIFFICULTY_CONFIG = {
            EASY: { 
                id: 'EASY', label: 'مبتدئ', subLabel: 'تدريب هادئ', icon: 'Baby', 
                multiplier: 1, 
                timeFactor: 1.3,
                colorTimer: 4000, 
                color: 'text-emerald-400', border: 'border-emerald-500/50', bg: 'bg-emerald-500/10', 
                mathRange: 10, gamePoints: { REFLEX: 30, COLOR: 50, MATH: 80 } 
            },
            MEDIUM: { 
                id: 'MEDIUM', label: 'متوسط', subLabel: 'التحدي القياسي', icon: 'Swords', 
                multiplier: 1.5, 
                timeFactor: 1.0,
                colorTimer: 2500,
                color: 'text-amber-400', border: 'border-amber-500/50', bg: 'bg-amber-500/10', 
                mathRange: 50, gamePoints: { REFLEX: 50, COLOR: 70, MATH: 100 } 
            },
            HARD: { 
                id: 'HARD', label: 'صعب', subLabel: 'للمحترفين', icon: 'Flame', 
                multiplier: 2, 
                timeFactor: 0.7,
                colorTimer: 1500,
                color: 'text-rose-500', border: 'border-rose-500/50', bg: 'bg-rose-500/10', 
                mathRange: 100, gamePoints: { REFLEX: 80, COLOR: 100, MATH: 150 } 
            }
        };

        // --- SHARED COMPONENTS ---
        const Button = ({ children, onClick, variant="primary", className="", disabled=false, ...props }) => {
            const styles = {
                primary: `bg-gradient-to-r from-indigo-600 to-violet-600 text-white shadow-lg active:scale-95 border-t border-white/10`,
                success: `bg-emerald-600 text-white active:scale-95 border-t border-white/10`,
                error: `bg-rose-600 text-white active:scale-95 border-t border-white/10`,
                ghost: "bg-transparent text-purple-300 hover:text-white border border-white/10 hover:bg-white/5"
            };
            return (
                <button 
                    onClick={(e) => { SoundManager.click(); onClick(e); }} disabled={disabled}
                    className={`w-full py-4 rounded-xl font-bold transition-all flex items-center justify-center gap-2 select-none ${styles[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
                    {...props}
                >
                    {children}
                </button>
            );
        };

        const Toggle = ({ label, checked, onChange }) => (
            <div className="flex items-center justify-between w-full bg-white/5 p-4 rounded-xl border border-white/10 mb-3">
                <span className="font-bold text-lg">{label}</span>
                <div className="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in" onClick={() => onChange(!checked)}>
                    <div className={`block overflow-hidden h-6 rounded-full cursor-pointer transition-colors ${checked ? 'bg-emerald-500' : 'bg-gray-700'}`}></div>
                    <div className={`absolute block w-6 h-6 rounded-full bg-white border-4 border-transparent shadow inset-y-0 left-0 transition-transform ${checked ? 'translate-x-full transform' : ''}`}></div>
                </div>
            </div>
        );

        // --- VIRTUAL KEYBOARD COMPONENT ---
        const VirtualKeyboard = ({ onKeyPress, onDelete, onSubmit }) => {
            const [layout, setLayout] = useState('AR'); // AR or EN

            const keysAR = [
                ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
                ['ض', 'ص', 'ث', 'ق', 'ف', 'غ', 'ع', 'ه', 'خ', 'ح', 'ج', 'د'],
                ['ش', 'س', 'ي', 'ب', 'ل', 'ا', 'ت', 'ن', 'م', 'ك', 'ط'],
                ['ئ', 'ء', 'ؤ', 'ر', 'لا', 'ى', 'ة', 'و', 'ز', 'ظ']
            ];

            const keysEN = [
                ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
                ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'],
                ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L'],
                ['Z', 'X', 'C', 'V', 'B', 'N', 'M']
            ];

            const currentKeys = layout === 'AR' ? keysAR : keysEN;

            return (
                <div className="fixed top-0 left-0 w-full bg-[#150a20]/95 backdrop-blur-xl border-b border-white/20 p-2 pb-4 pt-4 z-50 animate-slideUp flex flex-col gap-2 shadow-[0_10px_40px_rgba(0,0,0,0.5)] select-none">
                    
                    {/* Toolbar */}
                    <div className="flex justify-between px-2 mb-1">
                        <button onClick={() => setLayout(l => l === 'AR' ? 'EN' : 'AR')} className="text-xs font-bold text-purple-300 bg-white/5 px-3 py-1 rounded hover:bg-white/10">
                            {layout === 'AR' ? 'English' : 'عربي'}
                        </button>
                        <div onClick={onSubmit} className="text-xs font-bold text-gray-400 bg-white/5 px-3 py-1 rounded cursor-pointer hover:bg-white/10 flex items-center gap-1">
                            <Icon name="Keyboard" size={14}/> إغلاق
                        </div>
                    </div>

                    {currentKeys.map((row, i) => (
                        <div key={i} className="flex justify-center gap-1">
                            {row.map(char => (
                                <button 
                                    key={char} 
                                    onClick={(e) => { e.stopPropagation(); SoundManager.click(); onKeyPress(char); }}
                                    className="h-10 w-[9%] sm:w-10 rounded md:rounded-lg bg-white/10 hover:bg-white/25 active:bg-purple-500 active:scale-95 text-white font-bold transition-all shadow-sm border border-white/5 text-sm sm:text-base"
                                >
                                    {char}
                                </button>
                            ))}
                        </div>
                    ))}
                    
                    <div className="flex justify-center gap-2 mt-1 px-1">
                        <button onClick={() => { SoundManager.click(); onKeyPress(' '); }} className="h-11 flex-[2] rounded-lg bg-white/10 hover:bg-white/20 active:bg-white/30 text-white font-bold border border-white/5 text-sm">مسافة</button>
                        <button onClick={() => { SoundManager.click(); onDelete(); }} className="h-11 flex-1 rounded-lg bg-red-500/20 hover:bg-red-500/30 active:bg-red-500/40 text-red-200 border border-red-500/30 flex items-center justify-center"><Icon name="Delete" size={20} /></button>
                        <button onClick={() => { SoundManager.click(); onSubmit(); }} className="h-11 flex-1 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/30 active:bg-emerald-500/40 text-emerald-200 border border-emerald-500/30 flex items-center justify-center"><Icon name="Check" size={20} /></button>
                    </div>
                </div>
            );
        };

        // --- COPYRIGHT COMPONENT ---
        const CopyrightBadge = () => (
            <div className="fixed bottom-14 left-4 z-50 bg-[#1a0b2e]/90 backdrop-blur-xl border border-white/10 p-2 pr-4 rounded-2xl flex items-center gap-3 shadow-2xl shadow-purple-900/20 animate-slideUp">
                <img 
                    src="587278325_18547948189037653_3361709083164884238_n.jpg" 
                    alt="Event Plus" 
                    className="w-10 h-10 rounded-xl object-cover border border-white/5"
                    onError={(e) => {e.target.style.display='none'}}
                />
                <div className="flex flex-col">
                    <span className="text-[10px] text-gray-400 font-medium">جميع الحقوق محفوظة</span>
                    <span className="text-xs font-bold text-white tracking-widest font-sans uppercase">EVENT PLUS®</span>
                </div>
            </div>
        );

        const Footer = () => (
            <div className="fixed bottom-0 left-0 w-full z-40 bg-[#0f0518]/90 backdrop-blur-md border-t border-white/10 p-3 flex flex-wrap justify-center items-center gap-4 text-xs sm:text-sm">
                 <div className="flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/5"><span className="text-purple-400 font-bold uppercase tracking-wider">المطور الرئيسي</span><span className="flex items-center gap-1 text-white" dir="ltr"><Icon name="Instagram" size={14} /> @eventplus.om</span></div>
                <div className="w-px h-4 bg-white/10 hidden sm:block"></div>
                <div className="flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/5"><span className="text-pink-400 font-bold uppercase tracking-wider">للطلب و الاستفسار</span><span className="flex items-center gap-1 text-white" dir="ltr"><Icon name="Phone" size={14} /> +968 77220363</span></div>
            </div>
        );

        // --- HOOKS ---
        const useFairTimer = (initialTime, onEnd, isActive = true) => {
            const [timeLeft, setTimeLeft] = useState(initialTime);
            const endTimeRef = useRef(null);
            useEffect(() => {
                if (!isActive) return;
                endTimeRef.current = Date.now() + (initialTime * 1000);
                const interval = setInterval(() => {
                    const now = Date.now();
                    const remaining = Math.max(0, Math.ceil((endTimeRef.current - now) / 1000));
                    setTimeLeft(remaining);
                    if (remaining <= 0) {
                        clearInterval(interval);
                        if(onEnd) onEnd();
                    }
                }, 100);
                return () => clearInterval(interval);
            }, [isActive]);
            return timeLeft;
        };

        // --- GAMES ---
        const GameMath = ({ diff, onScore, onEnd, onLoseLife }) => {
            const [problem, setProblem] = useState({ t: "0+0", a: 0 });
            const [choices, setChoices] = useState([]);
            const timeLeft = useFairTimer(60 * diff.timeFactor, onEnd);
            const generate = useCallback(() => {
                const range = diff.mathRange;
                const n1 = Math.floor(Math.random() * range) + 1;
                const n2 = Math.floor(Math.random() * range) + 1;
                const isAdd = Math.random() > 0.5;
                const ans = isAdd ? n1 + n2 : n1 - n2;
                let w1 = ans + Math.floor(Math.random() * 5) + 1;
                let w2 = ans - Math.floor(Math.random() * 5) - 1;
                if (w1 === ans) w1++; if (w2 === ans) w2--;
                setChoices([ans, w1, w2].sort(() => Math.random() - 0.5));
                setProblem({ t: `${n1} ${isAdd ? '+' : '-'} ${n2}`, a: ans });
            }, [diff]);
            useEffect(() => { generate(); }, []);
            const handleAnswer = (val) => {
                if (val === problem.a) { SoundManager.correct(); onScore(Math.round(diff.gamePoints.MATH * diff.multiplier)); generate(); } 
                else { SoundManager.wrong(); onLoseLife(); generate(); }
            };
            return (
                <div className="flex flex-col items-center justify-center h-full gap-8 animate-slideUp">
                    <div className="text-2xl text-yellow-400 font-mono font-bold tracking-widest bg-black/30 px-6 py-2 rounded-full border border-yellow-500/30">{timeLeft}ث</div>
                    <div className="text-7xl font-black text-white tracking-widest drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">{problem.t}</div>
                    <div className="grid grid-cols-3 gap-4 w-full px-6 max-w-lg">
                        {choices.map((c, i) => <Button key={i} onClick={() => handleAnswer(c)} className="text-3xl h-24 bg-white/5 hover:bg-white/15 border border-white/20">{c}</Button>)}
                    </div>
                </div>
            );
        };

        const GameColor = ({ diff, onScore, onEnd, onLoseLife }) => {
            const COLORS = [{ name: "أحمر", code: "text-red-500" }, { name: "أزرق", code: "text-blue-500" }, { name: "أخضر", code: "text-green-500" }, { name: "أصفر", code: "text-yellow-500" }];
            const [current, setCurrent] = useState({ text: "", color: "", isMatch: false });
            const timeLeft = useFairTimer(45 * diff.timeFactor, onEnd);
            
            // Turn Key for per-color Timer
            const [turnKey, setTurnKey] = useState(0);

            const nextRound = useCallback(() => {
                const textObj = COLORS[Math.floor(Math.random() * COLORS.length)];
                const colorObj = COLORS[Math.floor(Math.random() * COLORS.length)];
                const isMatch = Math.random() > 0.5;
                setCurrent({ text: textObj.name, color: isMatch ? textObj.code : (COLORS.find(c => c.name !== textObj.name) || colorObj).code, isMatch });
                setTurnKey(k => k + 1); // Reset turn timer
            }, []);

            // Per-turn timer logic (Applies to ALL difficulties)
            useEffect(() => {
                const timer = setTimeout(() => {
                    // Time limit per color hit
                    SoundManager.wrong();
                    onLoseLife();
                    nextRound();
                }, diff.colorTimer); // Use the difficulty-specific color timer

                return () => clearTimeout(timer);
            }, [turnKey, diff, nextRound]);

            useEffect(() => { nextRound(); }, []);
            
            const handleChoice = (choice) => {
                if (choice === current.isMatch) { SoundManager.correct(); onScore(Math.round(diff.gamePoints.COLOR * diff.multiplier)); } 
                else { SoundManager.wrong(); onLoseLife(); }
                nextRound();
            };

            return (
                <div className="flex flex-col items-center justify-center h-full gap-10 animate-slideUp">
                    <div className="text-2xl text-yellow-400 font-mono font-bold tracking-widest bg-black/30 px-6 py-2 rounded-full border border-yellow-500/30">{timeLeft}ث</div>
                    <div className="text-center space-y-6 w-full max-w-md">
                        <p className="text-gray-400 text-lg">هل يطابق المعنى اللون؟</p>
                        <div className={`text-8xl font-black ${current.color} drop-shadow-2xl`}>{current.text}</div>
                        
                        {/* Per-Turn Timer Bar */}
                        <div className="w-full h-2 bg-gray-800 rounded-full overflow-hidden mt-4">
                            <div key={turnKey} className="h-full bg-red-500" style={{ animation: `timerShrink ${diff.colorTimer}ms linear forwards` }}></div>
                        </div>
                    </div>
                    <div className="flex gap-6 w-full px-8 max-w-md mt-4"><Button onClick={() => handleChoice(true)} variant="success" className="h-24 text-3xl">صح</Button><Button onClick={() => handleChoice(false)} variant="error" className="h-24 text-3xl">خطأ</Button></div>
                </div>
            );
        };

        const GameReflex = ({ diff, onScore, onEnd }) => {
            const timeLeft = useFairTimer(30 * diff.timeFactor, onEnd);
            const [targets, setTargets] = useState([]);
            useEffect(() => {
                const interval = setInterval(() => {
                    const id = Date.now();
                    const isBomb = Math.random() < 0.3;
                    setTargets(p => [...p, { id, x: Math.random() * 70 + 15, y: Math.random() * 50 + 25, isBomb }]);
                    setTimeout(() => setTargets(p => p.filter(t => t.id !== id)), 1500 / diff.multiplier);
                }, 800 / diff.multiplier);
                return () => clearInterval(interval);
            }, [diff]);
            const handleClick = (t) => {
                if (t.isBomb) { SoundManager.wrong(); onScore(-50 * diff.multiplier); navigator.vibrate?.(200); } 
                else { SoundManager.correct(); onScore(Math.round(diff.gamePoints.REFLEX * diff.multiplier)); }
                setTargets(p => p.filter(i => i.id !== t.id));
            };
            return (
                <div className="relative h-full w-full overflow-hidden animate-slideUp">
                    <div className="absolute top-4 left-0 right-0 flex justify-center pointer-events-none"><div className="text-2xl text-yellow-400 font-mono font-bold tracking-widest bg-black/30 px-6 py-2 rounded-full border border-yellow-500/30">{timeLeft}ث</div></div>
                    {targets.map(t => (
                        <div key={t.id} onPointerDown={(e) => { e.stopPropagation(); handleClick(t); }} className={`absolute w-20 h-20 rounded-full flex items-center justify-center cursor-pointer transform hover:scale-105 active:scale-90 transition-transform duration-100 ${t.isBomb ? 'bg-gradient-to-br from-red-500 to-rose-700' : 'bg-gradient-to-br from-emerald-400 to-green-600'} shadow-xl border-4 border-white/20`} style={{ left: `${t.x}%`, top: `${t.y}%` }}>
                            <Icon name={t.isBomb ? "Bomb" : "Target"} size={36} className="text-white" />
                        </div>
                    ))}
                    <div className="absolute bottom-10 w-full text-center text-white/30 text-sm pointer-events-none">اضغط على الأهداف، تجنب القنابل!</div>
                </div>
            );
        };

        // --- SCREENS ---
        const LeaderboardScreen = ({ onBack, currentScore }) => {
            const [scores, setScores] = useState([]);
            useEffect(() => {
                const stored = JSON.parse(localStorage.getItem('festival_scores') || '[]');
                setScores(stored.sort((a, b) => b.score - a.score).slice(0, 10));
            }, []);
            return (
                <div className="flex flex-col items-center h-full p-6 animate-slideUp w-full max-w-md mx-auto relative z-10">
                    <h2 className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-600 mb-6">لوحة الشرف</h2>
                    <div className="w-full bg-white/5 rounded-2xl border border-white/10 overflow-hidden mb-6 flex-1 max-h-[60vh] overflow-y-auto">
                        {scores.map((s, i) => (
                            <div key={i} className={`flex justify-between p-4 border-b border-white/5 ${s.score === currentScore ? 'bg-yellow-500/20' : ''}`}>
                                <div className="flex gap-3"><span className="font-mono text-yellow-500 w-6">#{i+1}</span><span className="font-bold">{s.name}</span></div>
                                <div className="font-mono text-emerald-400">{s.score}</div>
                            </div>
                        ))}
                        {scores.length === 0 && <div className="p-8 text-center text-gray-500">لا توجد نتائج بعد</div>}
                    </div>
                    <Button onClick={onBack}>عودة</Button>
                </div>
            );
        };

        const NameEntryScreen = ({ onNext }) => {
            const [name, setName] = useState("");
            const [showKeyboard, setShowKeyboard] = useState(false);

            const handleKeyPress = (char) => {
                if (name.length < 15) setName(prev => prev + char);
            };

            const handleDelete = () => {
                setName(prev => prev.slice(0, -1));
            };
            
            const handleSubmit = () => {
                 if (name.trim()) {
                     setShowKeyboard(false);
                     onNext(name);
                 }
            };

            return (
                <div className="flex flex-col items-center justify-center h-full gap-8 animate-slideUp p-6">
                    <h2 className="text-3xl font-bold">سجل اسمك للتحدي</h2>
                    
                    {/* Input Simulation - DIV instead of INPUT to prevent Android Keyboard */}
                    <div 
                        onClick={() => setShowKeyboard(true)}
                        className={`glass-input w-full max-w-xs text-2xl py-4 rounded-xl cursor-pointer relative select-none transition-all flex items-center justify-center min-h-[64px] ${showKeyboard ? 'border-purple-500 ring-2 ring-purple-500/20' : ''}`}
                    >
                        {name || <span className="text-white/30 text-lg">اضغط للكتابة</span>}
                        {showKeyboard && <span className="absolute animate-pulse text-purple-400 ml-1 translate-x-full">|</span>} 
                    </div>

                    <Button onClick={handleSubmit} disabled={!name.trim()} className="w-64">متابعة</Button>
                    
                    {showKeyboard && (
                        <VirtualKeyboard 
                            onKeyPress={handleKeyPress} 
                            onDelete={handleDelete} 
                            onSubmit={handleSubmit}
                        />
                    )}
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, sfx, music, onUpdate }) => {
            const [step, setStep] = useState('MAIN'); // MAIN, CONFIRM_DELETE
            const [deleteInput, setDeleteInput] = useState('');

            useEffect(() => {
                if(isOpen) {
                    setStep('MAIN');
                    setDeleteInput('');
                }
            }, [isOpen]);

            if (!isOpen) return null;

            const handleConfirmDelete = () => {
                if (deleteInput === "حذف") {
                    localStorage.removeItem('festival_scores');
                    SoundManager.delete();
                    setStep('MAIN');
                    alert("تم حذف السجل بنجاح");
                }
            };

            return (
                <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade">
                    <div className="bg-[#1a1025] border border-white/10 p-6 rounded-3xl w-full max-w-sm shadow-2xl transform scale-100 transition-all">
                        
                        {/* Header */}
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">
                                {step === 'MAIN' ? 'الإعدادات' : 'تأكيد الحذف'}
                            </h2>
                            <button onClick={onClose} className="p-2 bg-white/5 rounded-full hover:bg-white/10"><Icon name="X" size={24}/></button>
                        </div>

                        {step === 'MAIN' ? (
                            <>
                                <Toggle label="الموسيقى" checked={music} onChange={(val) => onUpdate('music', val)} />
                                <Toggle label="المؤثرات الصوتية" checked={sfx} onChange={(val) => onUpdate('sfx', val)} />
                                
                                <div className="mt-8 border-t border-white/10 pt-6">
                                    <h3 className="text-sm text-gray-400 mb-3 font-bold">إدارة البيانات</h3>
                                     <Button onClick={() => setStep('CONFIRM_DELETE')} variant="error" className="bg-red-900/50 hover:bg-red-800 border-red-500/30">
                                        <Icon name="Trash2" size={18} />
                                        حذف سجل المشاركين
                                     </Button>
                                </div>
                                <div className="mt-4">
                                     <Button onClick={onClose} variant="ghost">إغلاق</Button>
                                </div>
                            </>
                        ) : (
                            <div className="flex flex-col gap-4 animate-slideUp">
                                <div className="p-4 bg-red-500/10 border border-red-500/20 rounded-xl text-red-200 text-sm">
                                    <div className="flex items-center gap-2 mb-2 font-bold text-red-400">
                                        <Icon name="AlertTriangle" size={18} />
                                        تحذير هام
                                    </div>
                                    هل أنت متأكد من حذف جميع سجلات المشاركين؟ هذا الإجراء لا يمكن التراجع عنه.
                                </div>
                                
                                <div className="space-y-2">
                                    <label className="text-sm text-gray-400">لتأكيد الحذف، اكتب كلمة <span className="text-white font-bold">"حذف"</span> أدناه:</label>
                                    <input 
                                        type="text" 
                                        value={deleteInput}
                                        onChange={(e) => setDeleteInput(e.target.value)}
                                        className="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-center text-white focus:border-red-500 focus:outline-none transition-colors"
                                        placeholder="اكتب كلمة حذف هنا"
                                    />
                                </div>

                                <div className="flex gap-3 mt-2">
                                    <Button onClick={() => setStep('MAIN')} variant="ghost" className="w-1/2">إلغاء</Button>
                                    <Button 
                                        onClick={handleConfirmDelete} 
                                        disabled={deleteInput !== "حذف"}
                                        variant="error" 
                                        className={`w-1/2 ${deleteInput !== "حذف" ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    >
                                        تأكيد الحذف
                                    </Button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [screen, setScreen] = useState('HOME');
            const [gameType, setGameType] = useState(null);
            const [difficulty, setDifficulty] = useState('EASY');
            const [score, setScore] = useState(0);
            const [lives, setLives] = useState(3);
            const [playerName, setPlayerName] = useState("");
            
            // Settings State
            const [showSettings, setShowSettings] = useState(false);
            const [settings, setSettings] = useState({ sfx: true, music: true });

            // Global click handler to initialize audio
            useEffect(() => {
                const handleGlobalClick = () => {
                    if (audioCtx.state === 'suspended') {
                        audioCtx.resume();
                    }
                    if (settings.music && !bgmInterval) {
                        startBgm();
                    }
                };

                window.addEventListener('pointerdown', handleGlobalClick, { once: true });
                return () => window.removeEventListener('pointerdown', handleGlobalClick);
            }, [settings.music]);

            const updateSetting = (key, val) => {
                const newSettings = { ...settings, [key]: val };
                setSettings(newSettings);
                SoundManager.updateSettings(newSettings.sfx, newSettings.music);
            };

            const startGame = (type) => {
                setGameType(type); setScore(0); setLives(3); setScreen('GAME');
            };

            const handleScore = (pts) => setScore(s => Math.max(0, s + pts));
            const handleLoseLife = () => {
                setLives(l => { if (l - 1 <= 0) { setTimeout(finishGame, 100); return 0; } return l - 1; });
            };
            const finishGame = () => {
                SoundManager.win();
                const newRecord = { name: playerName, score, date: new Date().toISOString() };
                const existing = JSON.parse(localStorage.getItem('festival_scores') || '[]');
                localStorage.setItem('festival_scores', JSON.stringify([...existing, newRecord]));
                setScreen('SCORE');
            };

            return (
                <div className="h-full relative font-tajawal">
                    <div className="bg-hero-container"><div className="hero-orb orb-1"></div><div className="hero-orb orb-2"></div></div>
                    <div className="crt-scanline"></div>

                    {/* Settings Button */}
                    <div className="absolute top-4 left-4 z-40">
                        <button onClick={() => setShowSettings(true)} className="p-3 bg-white/10 rounded-full hover:bg-white/20 backdrop-blur-md border border-white/10 shadow-lg">
                            <Icon name="Settings" size={24} className="text-white" />
                        </button>
                    </div>

                    {/* Settings Modal */}
                    <SettingsModal 
                        isOpen={showSettings} 
                        onClose={() => setShowSettings(false)} 
                        sfx={settings.sfx} 
                        music={settings.music} 
                        onUpdate={updateSetting} 
                    />

                    {screen === 'HOME' && (
                        <div className="flex flex-col items-center justify-center h-full gap-8 animate-slideUp px-4 text-center">
                            <div className="relative mb-2">
                                <div className="absolute -inset-4 bg-purple-500/20 blur-xl rounded-full"></div>
                                <h1 className="relative text-5xl sm:text-7xl font-black bg-gradient-to-br from-white via-purple-200 to-purple-400 text-transparent bg-clip-text drop-shadow-sm tracking-tighter font-brand">
                                    EVENT PLUS<br/>GAMES
                                </h1>
                            </div>
                            
                            <div className="flex flex-col gap-4 w-full max-w-md mt-4">
                                <div onClick={() => { if(audioCtx.state === 'suspended') audioCtx.resume(); setScreen('NAME_ENTRY'); }} className="glass-panel p-6 rounded-2xl flex items-center gap-6 hover:bg-white/10 cursor-pointer border-l-4 border-l-purple-500/50 transition-all hover:translate-x-[-5px] group">
                                    <div className="p-4 bg-purple-900/30 rounded-full group-hover:scale-110 transition-transform"><Icon name="Rocket" size={32} className="text-purple-400" /></div>
                                    <div className="text-right flex-1">
                                        <div className="font-bold text-xl text-white">ابدأ المنافسة</div>
                                        <div className="text-sm text-white/40">سجل اسمك وانطلق في التحدي</div>
                                    </div>
                                    <Icon name="ChevronLeft" className="text-white/20 group-hover:text-white transition-colors" />
                                </div>

                                <div onClick={() => setScreen('LEADERBOARD')} className="glass-panel p-6 rounded-2xl flex items-center gap-6 hover:bg-white/10 cursor-pointer border-l-4 border-l-amber-500/50 transition-all hover:translate-x-[-5px] group">
                                    <div className="p-4 bg-amber-900/30 rounded-full group-hover:scale-110 transition-transform"><Icon name="Trophy" size={32} className="text-amber-400" /></div>
                                    <div className="text-right flex-1">
                                        <div className="font-bold text-xl text-white">لوحة الصدارة</div>
                                        <div className="text-sm text-white/40">شاهد أبطال المهرجان</div>
                                    </div>
                                    <Icon name="ChevronLeft" className="text-white/20 group-hover:text-white transition-colors" />
                                </div>
                            </div>
                        </div>
                    )}

                    {screen === 'NAME_ENTRY' && <NameEntryScreen onNext={(name) => { setPlayerName(name); setScreen('DIFFICULTY'); }} />}
                    
                    {screen === 'DIFFICULTY' && (
                        <div className="flex flex-col items-center justify-center h-full gap-4 animate-slideUp p-4 w-full max-w-lg mx-auto">
                            <h2 className="text-2xl font-bold text-white/80 mb-2">مرحباً {playerName}، اختر مستواك</h2>
                            {Object.values(DIFFICULTY_CONFIG).map(d => (
                                <div key={d.id} onClick={() => setDifficulty(d.id)} className={`w-full p-4 rounded-2xl border-2 cursor-pointer transition-all flex items-center justify-between group ${difficulty === d.id ? `${d.bg} ${d.border}` : 'bg-white/5 border-white/5 hover:bg-white/10'}`}>
                                    <div className="flex items-center gap-4"><div className={`p-3 rounded-full ${difficulty === d.id ? 'bg-black/20' : 'bg-white/5'}`}><Icon name={d.icon} className={d.color} size={24} /></div><div className="text-right"><div className={`font-bold ${d.color}`}>{d.label}</div><div className="text-sm text-white/40">{d.subLabel}</div></div></div>
                                    <div className="text-xs font-mono text-white/30 bg-black/20 px-2 py-1 rounded">x{d.multiplier}</div>
                                </div>
                            ))}
                            <div className="w-full flex gap-3 mt-4">
                                <Button onClick={() => setScreen('HOME')} variant="ghost" className="w-1/3">عودة</Button>
                                <Button onClick={() => setScreen('SELECT_GAME')} className="w-2/3" variant="primary">التالي</Button>
                            </div>
                        </div>
                    )}

                    {screen === 'SELECT_GAME' && (
                        <div className="flex flex-col justify-center h-full max-w-xl mx-auto p-6 animate-slideUp">
                            <div className="flex flex-col gap-4 w-full">
                                <div onClick={() => startGame('MATH')} className="glass-panel p-6 rounded-2xl flex items-center gap-6 hover:bg-white/10 cursor-pointer border-l-4 border-l-cyan-400/50 transition-all hover:translate-x-[-5px]">
                                    <div className="p-4 bg-cyan-900/30 rounded-full"><Icon name="Calculator" size={32} className="text-cyan-400" /></div>
                                    <div className="text-right flex-1">
                                        <div className="font-bold text-xl">تحدي الحساب</div>
                                        <div className="text-sm text-white/40">حل المسائل الرياضية بسرعة</div>
                                    </div>
                                    <Icon name="ChevronLeft" className="text-white/20" />
                                </div>

                                <div onClick={() => startGame('COLOR')} className="glass-panel p-6 rounded-2xl flex items-center gap-6 hover:bg-white/10 cursor-pointer border-l-4 border-l-pink-400/50 transition-all hover:translate-x-[-5px]">
                                    <div className="p-4 bg-pink-900/30 rounded-full"><Icon name="Palette" size={32} className="text-pink-400" /></div>
                                    <div className="text-right flex-1">
                                        <div className="font-bold text-xl">خداع الألوان</div>
                                        <div className="text-sm text-white/40">طابق المعنى مع اللون</div>
                                    </div>
                                    <Icon name="ChevronLeft" className="text-white/20" />
                                </div>

                                <div onClick={() => startGame('REFLEX')} className="glass-panel p-6 rounded-2xl flex items-center gap-6 hover:bg-white/10 cursor-pointer border-l-4 border-l-red-400/50 transition-all hover:translate-x-[-5px]">
                                    <div className="p-4 bg-red-900/30 rounded-full"><Icon name="MousePointer2" size={32} className="text-red-400" /></div>
                                    <div className="text-right flex-1">
                                        <div className="font-bold text-xl">سرعة اليد</div>
                                        <div className="text-sm text-white/40">اصطد الأهداف وتجنب القنابل</div>
                                    </div>
                                    <Icon name="ChevronLeft" className="text-white/20" />
                                </div>
                            </div>
                        </div>
                    )}

                    {screen === 'GAME' && (
                        <div className="h-full relative pt-20 pb-4">
                            <div className="absolute top-0 right-0 p-4 z-10">
                                <div className="flex flex-col items-end"><div className="font-mono text-3xl font-black text-white drop-shadow-md leading-none">{score}</div><div className={`text-xs font-bold ${DIFFICULTY_CONFIG[difficulty].color}`}>{DIFFICULTY_CONFIG[difficulty].label}</div></div>
                            </div>
                            <div className="absolute top-0 left-16 p-4 z-10">
                                <div className="flex gap-1 bg-black/40 p-2 rounded-full backdrop-blur-md border border-white/10">{[...Array(3)].map((_, i) => <Icon key={i} name="Heart" size={18} className={`${i < lives ? "text-red-500 fill-red-500" : "text-gray-700"}`} />)}</div>
                            </div>
                            
                            {gameType === 'MATH' && <GameMath diff={DIFFICULTY_CONFIG[difficulty]} onScore={handleScore} onEnd={finishGame} onLoseLife={handleLoseLife} />}
                            {gameType === 'COLOR' && <GameColor diff={DIFFICULTY_CONFIG[difficulty]} onScore={handleScore} onEnd={finishGame} onLoseLife={handleLoseLife} />}
                            {gameType === 'REFLEX' && <GameReflex diff={DIFFICULTY_CONFIG[difficulty]} onScore={handleScore} onEnd={finishGame} />}
                        </div>
                    )}

                    {screen === 'SCORE' && (
                        <div className="flex flex-col items-center justify-center h-full gap-6 animate-slideUp z-20 relative">
                            <div className="text-center">
                                <h2 className="text-2xl font-bold text-white/60 mb-2">أحسنت يا {playerName}</h2>
                                <div className="text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 drop-shadow-lg">{score}</div>
                            </div>
                            <div className="w-64 space-y-3">
                                <Button onClick={() => startGame(gameType)} variant="primary">إعادة اللعب</Button>
                                <Button onClick={() => setScreen('HOME')} variant="ghost">الرئيسية</Button>
                            </div>
                        </div>
                    )}

                    {screen === 'LEADERBOARD' && <LeaderboardScreen onBack={() => setScreen('HOME')} currentScore={score} />}
                    
                    <CopyrightBadge />
                    <Footer />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // --- 5-TAP FULLSCREEN SCRIPT ---
        let tapCount = 0;
        let tapTimer = null;
        document.addEventListener('click', function() {
            tapCount++;
            if (tapTimer) clearTimeout(tapTimer);
            tapTimer = setTimeout(() => { tapCount = 0; }, 400); 
            if (tapCount === 5) {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(e => console.log(e));
                }
                tapCount = 0;
            }
        });
    </script>
</body>
</html>
