<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Event Plus - ÿ™ÿ≠ÿØŸä ÿßŸÑŸÖŸáÿ±ÿ¨ÿßŸÜ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');

        body { 
            touch-action: none; 
            overflow: hidden; 
            user-select: none; 
            -webkit-user-select: none; 
            font-family: 'Tajawal', sans-serif;
            background-color: #0f0518;
        }
        
        /* --- BACKGROUNDS --- */
        .bg-hero-container {
            position: absolute; inset: 0; z-index: -2;
            background-color: #0f0518; overflow: hidden;
        }
        .hero-orb {
            position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5;
            animation: orbFloat 10s infinite ease-in-out alternate;
        }
        .orb-1 { top: -10%; left: -10%; width: 70vw; height: 70vw; background: radial-gradient(circle, #6d28d9 0%, transparent 70%); animation-duration: 12s; }
        .orb-2 { bottom: -20%; right: -10%; width: 60vw; height: 60vw; background: radial-gradient(circle, #1d4ed8 0%, transparent 70%); animation-duration: 15s; animation-delay: -5s; }
        .bg-hero-grid {
            position: absolute; inset: 0; z-index: -1;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px; mask-image: radial-gradient(circle at center, black 60%, transparent 100%);
        }
        @keyframes orbFloat { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(20px, 40px) scale(1.05); } }

        /* --- METEORS --- */
        .bg-meteor-container {
            position: absolute; inset: 0; background: linear-gradient(135deg, #1a0b2e 0%, #000000 100%); overflow: hidden; z-index: -2;
        }
        .meteor {
            position: absolute; width: 100px; height: 2px;
            background: linear-gradient(90deg, #ffffff, #a855f7, transparent); opacity: 0;
            filter: drop-shadow(0 0 5px rgba(168, 85, 247, 0.8)); transform: rotate(-45deg); z-index: -1;
        }
        @keyframes meteorFall {
            0% { opacity: 1; transform: translate(50px, -50px) rotate(-45deg); }
            100% { opacity: 0; transform: translate(-100vw, 100vh) rotate(-45deg); }
        }

        /* --- GAME BG --- */
        .bg-game-deep {
            background: radial-gradient(circle at center, #1e1b4b 0%, #000000 100%); position: absolute; inset: 0; z-index: -2;
        }
        .particle {
            position: absolute; background: rgba(168, 85, 247, 0.2); border-radius: 50%;
            animation: floatParticle 20s infinite linear;
        }
        @keyframes floatParticle { 0% { transform: translateY(0); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: translateY(-100vh); opacity: 0; } }

        /* --- UTILS --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            background: rgba(0, 0, 0, 0.5);
            border-color: #a855f7;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.2);
        }
        
        .animate-float { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        
        .crt-scanline {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 3px, 3px 100%; pointer-events: none; z-index: 50; position: absolute; inset: 0; opacity: 0.15;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #a855f7; cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(168,85,247,0.8); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.2); border-radius: 2px; }
        
        .animate-slideDown { animation: slideDown 0.4s ease-out forwards; }
        .animate-slideUp { animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-[#0f0518] text-white h-screen w-screen overflow-hidden">

    <div id="root" class="h-full w-full"></div>

    <audio id="bgAudio" loop>
        <source src="sound/1.mp3" type="audio/mpeg">
    </audio>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        const Icon = ({ name, size = 24, className, ...props }) => {
            if (!window.lucide || !window.lucide.icons) return null;
            const iconData = window.lucide.icons[name];
            if (!iconData) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                    {iconData.map((child, idx) => React.createElement(child[0], { key: idx, ...child[1] }))}
                </svg>
            );
        };

        const AUDIO_SETTINGS = { sfxOn: true, musicOn: true };

        // --- CONFIG ---
        const DIFFICULTY_CONFIG = {
            EASY: { 
                id: 'EASY', label: 'ŸÖÿ®ÿ™ÿØÿ¶', subLabel: 'ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ±ÿ≠ŸÑÿ©', icon: 'Sparkles',
                multiplier: 1, timeFactor: 1.0, speedFactor: 1.0, 
                color: 'text-emerald-400', bgGradient: 'from-emerald-900/40 to-emerald-900/10', border: 'border-emerald-500/30', glow: 'shadow-emerald-500/20',
                mathRange: 10, gamePoints: { REFLEX: 20, COLOR: 35, MATH: 80, QUIZ: 500 }, timeBonus: { MATH: 5, COLOR: 2, REFLEX: 0 }
            },
            MEDIUM: { 
                id: 'MEDIUM', label: 'ŸÖÿ≠ÿ™ÿ±ŸÅ', subLabel: 'ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑÿ≠ŸÇŸäŸÇŸä', icon: 'Zap',
                multiplier: 1.5, timeFactor: 0.66, speedFactor: 1.5, 
                color: 'text-amber-400', bgGradient: 'from-amber-900/40 to-amber-900/10', border: 'border-amber-500/30', glow: 'shadow-amber-500/20',
                mathRange: 50, gamePoints: { REFLEX: 30, COLOR: 50, MATH: 100, QUIZ: 1000 }, timeBonus: { MATH: 3, COLOR: 1.5, REFLEX: 0 }
            },
            HARD: { 
                id: 'HARD', label: 'ÿ£ÿ≥ÿ∑Ÿàÿ±Ÿä', subLabel: 'ŸÑŸÑŸÖÿ≠ÿ™ÿ±ŸÅŸäŸÜ ŸÅŸÇÿ∑', icon: 'Flame',
                multiplier: 2, timeFactor: 0.5, speedFactor: 2.0, 
                color: 'text-rose-500', bgGradient: 'from-rose-900/40 to-rose-900/10', border: 'border-rose-500/30', glow: 'shadow-rose-500/20',
                mathRange: 99, gamePoints: { REFLEX: 40, COLOR: 65, MATH: 150, QUIZ: 2000 }, timeBonus: { MATH: 2, COLOR: 1, REFLEX: 0 }
            }
        };

        const GAMES_LIST = [
            { id: 'REFLEX', name: 'ÿ±ÿØ ÿßŸÑŸÅÿπŸÑ', icon: 'MousePointer2', desc: 'ÿ™ÿ¨ŸÜÿ® ÿßŸÑŸÇŸÜÿßÿ®ŸÑ ÿ®ÿ≥ÿ±ÿπÿ©!', color: 'from-red-500 to-rose-700', border: 'group-hover:border-red-500', shadow: 'hover:shadow-red-500/50', hasLives: true },
            { id: 'MATH', name: 'ÿ™ÿ≠ÿØŸä ÿßŸÑÿ≠ÿ≥ÿßÿ®', icon: 'Calculator', desc: 'ÿßÿ¨ŸÖÿπ Ÿàÿßÿ∑ÿ±ÿ≠ ŸÇÿ®ŸÑ ÿßŸÑŸàŸÇÿ™', color: 'from-cyan-500 to-blue-700', border: 'group-hover:border-cyan-500', shadow: 'hover:shadow-cyan-500/50', hasLives: true },
            { id: 'COLOR', name: 'ÿÆÿØÿßÿπ ÿßŸÑÿ£ŸÑŸàÿßŸÜ', icon: 'Palette', desc: 'ŸÑÿß ÿ™ÿØÿπ ÿπŸäŸÜŸÉ ÿ™ÿÆÿØÿπŸÉ', color: 'from-pink-500 to-fuchsia-700', border: 'group-hover:border-pink-500', shadow: 'hover:shadow-pink-500/50', hasLives: true },
            { id: 'QUIZ', name: 'ÿ´ŸÇÿßŸÅÿ© ÿπŸÖÿßŸÜ', icon: 'Brain', desc: 'ÿßÿÆÿ™ÿ®ÿ± ŸÖÿπŸÑŸàŸÖÿßÿ™ŸÉ ÿßŸÑÿπÿßŸÖÿ©', color: 'from-blue-600 to-indigo-800', border: 'group-hover:border-blue-500', shadow: 'hover:shadow-blue-500/50', hasLives: true },
        ];

        const playSound = (type) => {
            if (!AUDIO_SETTINGS.sfxOn) return;
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                const now = ctx.currentTime;
                const sounds = {
                    click: () => { osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(600, now + 0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); },
                    correct: () => { osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, now); osc.frequency.setValueAtTime(659.25, now + 0.1); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0.2, now + 0.1); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4); osc.start(now); osc.stop(now + 0.4); },
                    bonus: () => { osc.type = 'square'; osc.frequency.setValueAtTime(800, now); osc.frequency.setValueAtTime(1200, now + 0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3); },
                    wrong: () => { osc.type = 'triangle'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2); gain.gain.setValueAtTime(0.15, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3); },
                    pop: () => { osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.05); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05); osc.start(now); osc.stop(now + 0.05); },
                    win: () => { osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now + 0.3); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.3, now + 0.2); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6); osc.start(now); osc.stop(now + 0.6); },
                    break: () => { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(20, now + 0.3); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3); }
                };
                if(sounds[type]) sounds[type]();
            } catch(e) { }
        };

        const Button = ({ children, onClick, variant="primary", className="", ...props }) => {
            const styles = {
                primary: `bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white shadow-lg shadow-indigo-500/30 border border-white/10 active:scale-[0.98]`,
                success: `bg-emerald-600 text-white active:scale-95`,
                error: `bg-rose-600 text-white active:scale-95`,
                neutral: "bg-slate-700 text-slate-200 active:scale-95",
                ghost: "bg-transparent text-purple-300 hover:text-white hover:bg-white/5 border border-white/10"
            };
            return (
                <button 
                    onClick={(e) => { playSound('click'); onClick && onClick(e); }}
                    className={`w-full py-4 rounded-xl font-bold transition-all duration-200 flex items-center justify-center gap-2 select-none ${styles[variant]} ${className}`}
                    {...props}
                >
                    {children}
                </button>
            );
        };

        const MusicController = ({ volume, setVolume, color="text-white" }) => (
            <div className="flex items-center gap-2 w-full">
                <Icon name="Volume1" size={16} className={color} />
                <input type="range" min="0" max="1" step="0.05" value={volume} onChange={(e) => setVolume(parseFloat(e.target.value))} className="flex-1" />
                <Icon name="Volume2" size={16} className={color} />
            </div>
        );

        const SettingsModal = ({ isOpen, onClose, audioSettings, setAudioSettings, globalVolume, setGlobalVolume }) => {
            const [confirmStep, setConfirmStep] = useState(false);
            const [inputValue, setInputValue] = useState("");
            
            if (!isOpen) return null;

            const handleClearData = () => {
                if (inputValue === "ÿ≠ÿ∞ŸÅ") {
                    localStorage.removeItem('eventPlusLeaderboardAR');
                    setConfirmStep(false);
                    setInputValue("");
                    playSound('break');
                    onClose(); 
                } else {
                    playSound('wrong');
                }
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-md animate-fade-in p-4">
                    <div className="glass-panel p-6 rounded-3xl w-full max-w-sm relative">
                        <button onClick={onClose} className="absolute top-4 left-4 p-2 bg-white/5 rounded-full hover:bg-white/10 transition-colors"><Icon name="X" /></button>
                        <h2 className="text-2xl font-bold mb-8 text-center flex items-center justify-center gap-2"><Icon name="Settings" /> ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</h2>
                        <div className="space-y-4">
                            <div className="flex justify-between items-center bg-white/5 p-4 rounded-2xl border border-white/5">
                                <div className="flex items-center gap-3"><Icon name={audioSettings.musicOn ? "Music" : "Music2"} className="text-purple-400" /><span>ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ</span></div>
                                <button onClick={() => setAudioSettings(prev => ({...prev, musicOn: !prev.musicOn}))} className={`w-12 h-6 rounded-full p-1 transition-colors ${audioSettings.musicOn ? 'bg-green-500' : 'bg-slate-600'}`}><div className={`w-4 h-4 bg-white rounded-full transition-transform ${audioSettings.musicOn ? 'translate-x-0' : '-translate-x-6'}`}></div></button>
                            </div>
                            <div className="flex justify-between items-center bg-white/5 p-4 rounded-2xl border border-white/5">
                                <div className="flex items-center gap-3"><Icon name={audioSettings.sfxOn ? "Volume2" : "VolumeX"} className="text-pink-400" /><span>ÿßŸÑŸÖÿ§ÿ´ÿ±ÿßÿ™ (SFX)</span></div>
                                <button onClick={() => { AUDIO_SETTINGS.sfxOn = !audioSettings.sfxOn; setAudioSettings(prev => ({...prev, sfxOn: !prev.sfxOn})); }} className={`w-12 h-6 rounded-full p-1 transition-colors ${audioSettings.sfxOn ? 'bg-green-500' : 'bg-slate-600'}`}><div className={`w-4 h-4 bg-white rounded-full transition-transform ${audioSettings.sfxOn ? 'translate-x-0' : '-translate-x-6'}`}></div></button>
                            </div>
                            
                            <div className="bg-white/5 p-4 rounded-2xl border border-white/5 flex flex-col gap-3">
                                <div className="flex items-center gap-2 text-white/70 text-sm"><Icon name="Sliders" size={14} /> ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿµŸàÿ™</div>
                                <MusicController volume={globalVolume} setVolume={setGlobalVolume} />
                            </div>

                            <div className="pt-2">
                                {!confirmStep ? (
                                    <button onClick={() => setConfirmStep(true)} className="w-full p-4 rounded-xl font-bold bg-red-900/20 text-red-400 border border-red-500/20 hover:bg-red-900/40 transition-all flex items-center justify-center gap-2"><Icon name="Trash2" size={18} /> ŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿµÿØÿßÿ±ÿ©</button>
                                ) : (
                                    <div className="flex flex-col gap-2 bg-red-900/10 p-3 rounded-2xl border border-red-500/20">
                                        <p className="text-xs text-red-300 text-center">ÿßŸÉÿ™ÿ® "ÿ≠ÿ∞ŸÅ" ŸÑŸÑÿ™ÿ£ŸÉŸäÿØ</p>
                                        <input type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} className="w-full p-3 rounded-xl bg-black/40 border border-red-500/30 text-center focus:outline-none focus:border-red-500" placeholder="ÿ≠ÿ∞ŸÅ" />
                                        <button onClick={handleClearData} disabled={inputValue !== "ÿ≠ÿ∞ŸÅ"} className={`w-full p-3 rounded-xl font-bold transition-all ${inputValue === "ÿ≠ÿ∞ŸÅ" ? 'bg-red-600 text-white shadow-lg shadow-red-600/30' : 'bg-white/5 text-white/30'}`}>ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const MusicPlayer = ({ isInGame, volume, enabled }) => {
            const audioRef = useRef(null);
            
            useEffect(() => {
                const initAudio = () => {
                    if (audioRef.current && audioRef.current.paused && enabled) {
                        audioRef.current.play().catch(e => console.log("Audio autoplay restricted"));
                    }
                };
                document.addEventListener('click', initAudio, { once: true });
                document.addEventListener('touchstart', initAudio, { once: true });
                return () => {
                    document.removeEventListener('click', initAudio);
                    document.removeEventListener('touchstart', initAudio);
                };
            }, [enabled]);

            useEffect(() => {
                audioRef.current = document.getElementById('bgAudio');
                if(audioRef.current && !enabled) audioRef.current.pause();
                else if(audioRef.current && enabled) audioRef.current.play().catch(e=>{});
            }, [enabled]);

            useEffect(() => {
                const audio = audioRef.current;
                if (!audio || !enabled) return;
                const targetVolume = isInGame ? (volume * 0.5) : volume; 
                if (Math.abs(audio.volume - targetVolume) < 0.01) { audio.volume = targetVolume; return; }
                const fadeInterval = setInterval(() => {
                    const currentVolume = audio.volume;
                    const diff = targetVolume - currentVolume;
                    if (Math.abs(diff) < 0.02) { audio.volume = targetVolume; clearInterval(fadeInterval); }
                    else { audio.volume = diff > 0 ? Math.min(1, currentVolume + 0.02) : Math.max(0, currentVolume - 0.02); }
                }, 50);
                return () => clearInterval(fadeInterval);
            }, [isInGame, volume, enabled]);
            return null;
        };

        const Footer = () => (
            <div className="fixed bottom-0 left-0 w-full z-40 bg-[#0f0518]/90 backdrop-blur-md border-t border-white/10 p-3 flex flex-wrap justify-center items-center gap-4 text-xs sm:text-sm">
                 <div className="flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/5"><span className="text-purple-400 font-bold uppercase tracking-wider">ÿßŸÑŸÖÿ∑Ÿàÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä</span><span className="flex items-center gap-1 text-white" dir="ltr"><Icon name="Instagram" size={14} /> @eventplus.om</span></div>
                <div className="w-px h-4 bg-white/10 hidden sm:block"></div>
                <div className="flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/5"><span className="text-pink-400 font-bold uppercase tracking-wider">ŸÑŸÑÿ∑ŸÑÿ® Ÿà ÿßŸÑÿßÿ≥ÿ™ŸÅÿ≥ÿßÿ±</span><span className="flex items-center gap-1 text-white" dir="ltr"><Icon name="Phone" size={14} /> +968 77220363</span></div>
            </div>
        );

        // --- COPYRIGHT COMPONENT (Adjusted Position) ---
        const CopyrightBadge = () => (
            <div className="fixed bottom-14 left-4 z-50 bg-[#1a0b2e]/90 backdrop-blur-xl border border-white/10 p-2 pr-4 rounded-2xl flex items-center gap-3 shadow-2xl shadow-purple-900/20 animate-slideUp">
                <img 
                    src="587278325_18547948189037653_3361709083164884238_n.jpg" 
                    alt="Event Plus" 
                    className="w-10 h-10 rounded-xl object-cover border border-white/5"
                    onError={(e) => {e.target.style.display='none'}}
                />
                <div className="flex flex-col">
                    <span className="text-[10px] text-gray-400 font-medium">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ©</span>
                    <span className="text-xs font-bold text-white tracking-widest font-sans uppercase">EVENT PLUS¬Æ</span>
                </div>
            </div>
        );

        const VirtualKeyboard = ({ onChar, onDelete, onEnter, isVisible }) => {
            if (!isVisible) return null;
            const rows = [['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'], ['ÿ∂', 'ÿµ', 'ÿ´', 'ŸÇ', 'ŸÅ', 'ÿ∫', 'ÿπ', 'Ÿá', 'ÿÆ', 'ÿ≠', 'ÿ¨', 'ÿØ'], ['ÿ¥', 'ÿ≥', 'Ÿä', 'ÿ®', 'ŸÑ', 'ÿß', 'ÿ™', 'ŸÜ', 'ŸÖ', 'ŸÉ', 'ÿ∑'], ['ÿ∞', 'ÿ¶', 'ÿ°', 'ÿ§', 'ÿ±', 'ŸÑÿß', 'Ÿâ', 'ÿ©', 'Ÿà', 'ÿ≤', 'ÿ∏'], ['SPACE', 'DEL', 'ENTER']];
            return (
                <div className="absolute top-0 left-0 w-full bg-slate-900/95 border-b-2 border-purple-500/50 p-2 z-50 shadow-2xl backdrop-blur-md animate-slideDown">
                    <div className="flex flex-col gap-2 max-w-4xl mx-auto">
                        {rows.map((row, i) => (
                            <div key={i} className="flex justify-center gap-1">
                                {row.map((key) => {
                                    if (key === 'SPACE') return <button key={key} onClick={() => onChar(' ')} className="h-12 flex-1 max-w-[200px] bg-slate-700 rounded-lg text-white font-bold border border-white/10">ŸÖÿ≥ÿßŸÅÿ©</button>;
                                    if (key === 'DEL') return <button key={key} onClick={onDelete} className="h-12 w-20 bg-red-900/50 rounded-lg text-white font-bold border border-white/10 flex items-center justify-center"><Icon name="Delete" size={20} /></button>;
                                    if (key === 'ENTER') return <button key={key} onClick={onEnter} className="h-12 w-24 bg-green-600 rounded-lg text-white font-bold border border-white/10">ÿ™ÿ£ŸÉŸäÿØ</button>;
                                    return <button key={key} onClick={() => onChar(key)} className="h-12 w-10 sm:w-12 bg-slate-700 rounded-lg text-white font-bold text-lg border border-white/10 shadow-sm">{key}</button>;
                                })}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const HeartUnit = ({ broken }) => (
            <div className={`relative w-6 h-6 transition-all duration-300 ${broken ? 'opacity-50' : 'opacity-100'}`}>
                {broken ? <div className="animate-heart-break absolute inset-0 text-gray-500"><Icon name="HeartCrack" size={24} fill="currentColor" /></div> : <Icon name="Heart" size={24} className="text-red-500 fill-red-500 drop-shadow-glow" />}
            </div>
        );

        const LivesDisplay = ({ maxLives, currentLives }) => (
            <div className="flex gap-2 bg-black/40 p-2 rounded-full backdrop-blur-sm border border-white/10">
                {[...Array(maxLives)].map((_, i) => (<HeartUnit key={i} broken={i >= currentLives} />))}
            </div>
        );

        const GameMath = ({ diff, onScore, onEnd, onLifeLost }) => {
            const [problem, setProblem] = useState(null);
            const [timeLeft, setTimeLeft] = useState(20 * diff.timeFactor);
            const [streak, setStreak] = useState(0);

            const generateProblem = useCallback(() => {
                const range = diff.mathRange;
                const isAddition = Math.random() > 0.5;
                let n1 = Math.floor(Math.random() * range) + 1;
                let n2 = Math.floor(Math.random() * range) + 1;
                if (!isAddition && n1 < n2) [n1, n2] = [n2, n1];
                const ans = isAddition ? n1 + n2 : n1 - n2;
                let wrong1 = ans + Math.floor(Math.random() * 5) + 1;
                let wrong2 = ans - Math.floor(Math.random() * 5) - 1;
                if (wrong2 < 0) wrong2 = ans + 2; 
                setProblem({ n1, n2, op: isAddition ? '+' : '-', ans, options: [ans, wrong1, wrong2].sort(() => Math.random() - 0.5) });
            }, [diff]);

            useEffect(() => {
                generateProblem();
                const timer = setInterval(() => { setTimeLeft(t => { if(t <= 0) { clearInterval(timer); onEnd(); return 0; } return t - 0.1; }); }, 100);
                return () => clearInterval(timer);
            }, [generateProblem]);

            const handleAnswer = (val) => {
                if (val === problem.ans) {
                    let pts = diff.gamePoints.MATH;
                    if (streak >= 2) { pts = Math.floor(pts * 1.5); playSound('bonus'); } else playSound('correct');
                    setTimeLeft(prev => Math.min(prev + diff.timeBonus.MATH, 30)); 
                    onScore(pts); setStreak(s=>s+1); generateProblem();
                } else { playSound('wrong'); onLifeLost(); setStreak(0); generateProblem(); }
            };
            if (!problem) return null;
            return (
                <div className="flex flex-col items-center justify-center h-full gap-8">
                     <div className="flex justify-between w-full px-8"><div className="text-xl text-white/70">ÿßÿ≠ÿ≥ÿ® ÿ®ÿ≥ÿ±ÿπÿ©!</div><div className="text-xl font-mono text-yellow-400">{Math.ceil(timeLeft)}ÿ´</div></div>
                    <div className="flex items-center gap-4 text-7xl font-black text-white"><span>{problem.n1}</span><span className="text-purple-400">{problem.op}</span><span>{problem.n2}</span><span className="text-white/50">=</span><span className="text-yellow-400">?</span></div>
                    <div className="grid grid-cols-3 gap-4 w-full max-w-lg px-4 mt-8">{problem.options.map((opt, i) => (<Button key={i} onClick={() => handleAnswer(opt)} variant="neutral" className="text-3xl aspect-[4/3] h-auto">{opt}</Button>))}</div>
                </div>
            );
        };

        const GameQuiz = ({ diff, onScore, onEnd, onLifeLost }) => {
            const [questions, setQuestions] = useState([]);
            const [qIdx, setQIdx] = useState(0);
            const [timeLeft, setTimeLeft] = useState(15 * diff.timeFactor);
            const QUESTIONS_DB = {
                EASY: [{q: "ÿπÿßÿµŸÖÿ© ÿßŸÑÿ≥ŸÑÿ∑ŸÜÿ©ÿü", a:["ŸÖÿ≥ŸÇÿ∑","ÿµŸÑÿßŸÑÿ©","ÿµÿ≠ÿßÿ±"], c:"ŸÖÿ≥ŸÇÿ∑"}, {q:"ÿßŸÑÿπŸÖŸÑÿ©ÿü", a:["ÿßŸÑÿ±ŸäÿßŸÑ","ÿßŸÑÿØŸäŸÜÿßÿ±","ÿßŸÑÿØÿ±ŸáŸÖ"], c:"ÿßŸÑÿ±ŸäÿßŸÑ"}, {q:"ŸÑŸàŸÜ ÿßŸÑÿÆŸÜÿ¨ÿ± ÿ®ÿßŸÑÿπŸÑŸÖÿü", a:["ÿ£ÿ®Ÿäÿ∂","ÿ£ÿ≠ŸÖÿ±","ÿ£ÿÆÿ∂ÿ±"], c:"ÿ£ÿ®Ÿäÿ∂"}],
                MEDIUM: [{q: "ÿ£ŸäŸÜ ŸäŸàÿ¨ÿØ ÿßŸÑÿ¨ÿ®ŸÑ ÿßŸÑÿ£ÿÆÿ∂ÿ±ÿü", a:["ÿßŸÑÿØÿßÿÆŸÑŸäÿ©","ÿ∏ŸÅÿßÿ±","ŸÖÿ≥ŸÇÿ∑"], c:"ÿßŸÑÿØÿßÿÆŸÑŸäÿ©"}, {q:"ŸÑŸÇÿ® ÿµÿ≠ÿßÿ± ŸÇÿØŸäŸÖÿßŸãÿü", a:["ÿØŸáŸÑŸäÿ≤ ÿßŸÑÿµŸäŸÜ","ÿßŸÑŸÖÿ≤ŸàŸÜ","ŸÖÿ¨ÿßŸÜ"], c:"ÿØŸáŸÑŸäÿ≤ ÿßŸÑÿµŸäŸÜ"}],
                HARD: [{q: "ÿ™ÿßÿ±ŸäÿÆ ÿÆÿ±Ÿàÿ¨ ÿßŸÑÿ®ÿ±ÿ™ÿ∫ÿßŸÑŸäŸäŸÜÿü", a:["1650","1507","1741"], c:"1650"}, {q:"ŸÖÿ§ÿ≥ÿ≥ ÿØŸàŸÑÿ© ÿßŸÑÿ®Ÿàÿ≥ÿπŸäÿØÿü", a:["ÿ£ÿ≠ŸÖÿØ ÿ®ŸÜ ÿ≥ÿπŸäÿØ","ÿ≥ŸÑÿ∑ÿßŸÜ ÿ®ŸÜ ÿ≥ŸäŸÅ","ÿ≥ŸäŸÅ ÿ®ŸÜ ÿ≥ŸÑÿ∑ÿßŸÜ"], c:"ÿ£ÿ≠ŸÖÿØ ÿ®ŸÜ ÿ≥ÿπŸäÿØ"}]
            };
            useEffect(() => {
                const pool = QUESTIONS_DB[diff.id] || QUESTIONS_DB.EASY;
                setQuestions(pool.sort(() => Math.random() - 0.5).slice(0, 5));
                const timer = setInterval(() => { setTimeLeft(t => { if(t <= 0) { clearInterval(timer); onEnd(); return 0; } return t - 0.1; }); }, 100);
                return () => clearInterval(timer);
            }, [diff.id]);
            const handleAns = (ans) => {
                if(ans === questions[qIdx].c) { playSound('correct'); onScore(diff.gamePoints.QUIZ); }
                else { playSound('wrong'); onLifeLost(); }
                if(qIdx < questions.length - 1) { setQIdx(qIdx+1); setTimeLeft(15 * diff.timeFactor); } else onEnd();
            };
            if (questions.length === 0) return <div>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>;
            return (
                <div className="flex flex-col h-full justify-center space-y-6">
                    <div className="flex justify-between px-4"><span>ÿ≥ÿ§ÿßŸÑ {qIdx+1}</span><span className="text-yellow-400">{Math.ceil(timeLeft)}ÿ´</span></div>
                    <div className="bg-white/10 p-8 rounded-2xl text-2xl font-bold text-center">{questions[qIdx].q}</div>
                    <div className="grid gap-4">{questions[qIdx].a.map((opt, i) => (<Button key={i} onClick={() => handleAns(opt)} variant="neutral">{opt}</Button>))}</div>
                </div>
            );
        };

        const GameReflex = ({ diff, onScore, onEnd, onLifeLost }) => {
            const [active, setActive] = useState(null); 
            const [timeLeft, setTimeLeft] = useState(30);
            const [streak, setStreak] = useState(0); 
            const timerRef = useRef(null);
            const activeRef = useRef(null);
            const mountedRef = useRef(true);

            useEffect(() => {
                mountedRef.current = true;
                spawnTarget();
                const gameTimer = setInterval(() => { setTimeLeft(t => { if(t<=0) { onEnd(); return 0; } return t-1; }); }, 1000);
                return () => { mountedRef.current = false; clearInterval(gameTimer); clearTimeout(timerRef.current); };
            }, []);
            useEffect(() => { activeRef.current = active; }, [active]);

            const spawnTarget = () => {
                if (!mountedRef.current) return;
                if(timerRef.current) clearTimeout(timerRef.current);
                
                const nextType = Math.random() > 0.3 ? 'TARGET' : 'BOMB';
                const nextObj = { index: Math.floor(Math.random() * 9), type: nextType };
                setActive(nextObj);
                
                const duration = 1000 / diff.speedFactor;
                timerRef.current = setTimeout(() => { 
                    if (mountedRef.current) {
                        if (activeRef.current && activeRef.current.type === 'TARGET') {
                            onLifeLost(); 
                            playSound('break'); 
                            setStreak(0);
                        }
                        setActive(null); 
                        setTimeout(spawnTarget, 200);
                    }
                }, duration); 
            };

            const handleClick = (idx) => {
                if (!active || idx !== active.index) return; 

                if(active.type === 'TARGET') {
                    let pts = diff.gamePoints.REFLEX;
                    if(streak >= 3) { pts = Math.floor(pts * 1.5); playSound('bonus'); } else playSound('pop');
                    onScore(pts); setStreak(s=>s+1);
                    setActive(null); spawnTarget(); 
                } else if (active.type === 'BOMB') {
                    playSound('break'); 
                    onLifeLost(); 
                    setStreak(0); 
                    setActive(null); spawnTarget();
                }
            };

            return (
                <div className="flex flex-col items-center justify-center h-full w-full">
                    <div className="flex justify-between w-full max-w-md px-4 mb-4">
                         <div className="text-3xl font-mono text-yellow-400">{timeLeft}ÿ´</div>
                         {streak > 2 && <div className="text-green-400 font-bold animate-pulse">üî• x{streak > 3 ? '2' : '1.5'}</div>}
                    </div>
                    {/* Responsive Grid Container */}
                    <div className="grid grid-cols-3 gap-3 bg-white/5 p-4 rounded-2xl border border-white/10 w-full max-w-md aspect-square">
                        {[...Array(9)].map((_, i) => (
                            <button key={i} onClick={() => handleClick(i)} className={`w-full h-full aspect-square rounded-xl flex items-center justify-center bg-slate-800 scale-95 border border-white/5 overflow-hidden transition-colors hover:bg-slate-700`}>
                                {active && active.index === i && (
                                    <div className={`animate-bounceIn w-full h-full flex items-center justify-center`}>
                                        {active.type === 'TARGET' ? (
                                            <div className="w-[70%] h-[70%] bg-green-500 rounded-lg shadow-[0_0_15px_rgba(34,197,94,0.8)] border-4 border-green-300 animate-pulse"></div>
                                        ) : (
                                            <div className="relative w-[70%] h-[70%] bg-red-600 rounded-full flex items-center justify-center shadow-[0_0_15px_rgba(220,38,38,0.8)] border-4 border-red-400">
                                                <Icon name="Bomb" size={32} className="text-black drop-shadow-sm absolute w-1/2 h-1/2" />
                                            </div>
                                        )}
                                    </div>
                                )}
                            </button>
                        ))}
                    </div>
                    <div className="mt-4 text-center text-sm opacity-60">
                        <p>ÿßÿ∂ÿ∫ÿ∑ <span className="text-green-400">‚ñ†</span> ÿ®ÿ≥ÿ±ÿπÿ©!</p>
                        <p>ÿ™ÿ¨ŸÜÿ® <Icon name="Bomb" size={14} className="inline text-red-500"/> (ÿ™ŸÉÿ≥ÿ± ÿßŸÑŸÇŸÑÿ® ŸàŸÑÿß ÿ™ŸÜŸÇÿµ ÿßŸÑŸÜŸÇÿßÿ∑)</p>
                    </div>
                </div>
            );
        };

        const GameColor = ({ diff, onScore, onEnd, onLifeLost }) => {
            const COLORS = [{ n: 'ÿ£ÿ≠ŸÖÿ±', h: 'text-red-500'}, { n: 'ÿ£ÿ≤ÿ±ŸÇ', h: 'text-blue-500'}, { n: 'ÿ£ÿÆÿ∂ÿ±', h: 'text-green-500'}, { n: 'ÿ£ÿµŸÅÿ±', h: 'text-yellow-500'}];
            const [current, setCurrent] = useState({ text: '', color: '', match: false });
            const [timeLeft, setTimeLeft] = useState(20);
            useEffect(() => { nextRound(); const t = setInterval(() => setTimeLeft(p => { if(p<=0){onEnd(); return 0;} return p-1; }), 1000); return () => clearInterval(t); }, []);
            const nextRound = () => {
                const tO = COLORS[Math.floor(Math.random() * 4)];
                const cO = COLORS[Math.floor(Math.random() * 4)];
                const isMatch = Math.random() > 0.5;
                if (isMatch) setCurrent({ text: tO.n, color: tO.h, match: true });
                else { let fC = cO; while(fC.n === tO.n) fC = COLORS[Math.floor(Math.random() * 4)]; setCurrent({ text: tO.n, color: fC.h, match: false }); }
            };
            const handleChoice = (c) => {
                if (c === current.match) { 
                    playSound('correct'); 
                    setTimeLeft(prev => Math.min(prev + diff.timeBonus.COLOR, 30));
                    onScore(diff.gamePoints.COLOR); 
                }
                else { playSound('wrong'); onLifeLost(); }
                nextRound();
            };
            return (
                <div className="flex flex-col items-center justify-center h-full gap-8">
                    <div className={`text-6xl font-black ${current.color} drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] scale-150`}>{current.text}</div>
                    <div className="text-2xl font-mono text-yellow-400">{timeLeft}ÿ´</div>
                    <div className="flex gap-4 w-full px-8 max-w-lg"><Button onClick={() => handleChoice(true)} variant="success" className="flex-1 h-20 text-2xl">ÿµÿ≠</Button><Button onClick={() => handleChoice(false)} variant="error" className="flex-1 h-20 text-2xl">ÿÆÿ∑ÿ£</Button></div>
                </div>
            );
        };

        const GameEngine = ({ gameId, difficulty, onExit, onAutoSave, onViewLeaderboard, onHome, volume, onOpenSettings }) => {
            const [score, setScore] = useState(0);
            const [isOver, setIsOver] = useState(false);
            const [lives, setLives] = useState(3);
            const config = DIFFICULTY_CONFIG[difficulty];
            const gameData = GAMES_LIST.find(g => g.id === gameId);

            useEffect(() => { if (isOver) { onAutoSave(score); playSound('win'); } }, [isOver]);

            const handleScore = useCallback((pts) => { setScore(s => Math.max(0, s + pts)); }, []);
            
            const handleLifeLost = () => {
                playSound('break'); 
                setLives(prev => {
                    const newLives = prev - 1;
                    if(newLives <= 0) { handleEnd(); return 0; }
                    return newLives;
                });
            };
            const handleEnd = () => { setIsOver(true); };

            if (isOver) {
                return (
                    <div className="flex flex-col items-center justify-center h-full animate-float space-y-6">
                        {lives <= 0 ? <Icon name="Skull" size={80} className="text-red-500" /> : <Icon name="Trophy" size={80} className="text-yellow-400" />}
                        <h2 className="text-4xl font-bold">{lives <= 0 ? 'ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ©!' : 'ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©'}</h2>
                        <div className="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">{score}</div>
                        <div className="flex flex-col w-64 gap-3">
                            <Button onClick={onViewLeaderboard} variant="success" className="w-full"><Icon name="List" size={20} /> ŸÑŸàÿ≠ÿ© ÿßŸÑÿµÿØÿßÿ±ÿ©</Button>
                            <Button onClick={() => onHome(score)} variant="error" className="w-full"><Icon name="LogOut" size={20} /> ÿÆÿ±Ÿàÿ¨</Button>
                        </div>
                    </div>
                );
            }

            const props = { diff: config, onScore: handleScore, onEnd: handleEnd, onLifeLost: handleLifeLost };

            return (
                <div className="h-full w-full max-w-2xl mx-auto p-4 flex flex-col pb-16">
                    <div className="flex justify-between items-center mb-4 bg-slate-800/80 backdrop-blur p-3 rounded-xl border border-white/10 shadow-lg relative">
                         <button onClick={onOpenSettings} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors"><Icon name="Settings" size={20} /></button>
                        <div className="flex gap-2 items-center">
                            <Button onClick={handleEnd} variant="ghost" className="px-3 py-1 text-xs h-8">ÿ•ŸÜŸáÿßÿ°</Button>
                            {gameData?.hasLives && <LivesDisplay maxLives={3} currentLives={lives} />}
                        </div>
                        <div className="font-bold text-xl font-mono text-purple-300">{score} <span className="text-xs text-white/50">XP</span></div>
                    </div>
                    
                    <div className={`flex-1 bg-slate-900/50 rounded-2xl border border-white/5 relative overflow-hidden p-2 shadow-inner ${lives <= 0 ? 'animate-shake' : ''}`}>
                        {gameId === 'QUIZ' && <GameQuiz {...props} />}
                        {gameId === 'REFLEX' && <GameReflex {...props} />}
                        {gameId === 'COLOR' && <GameColor {...props} />}
                        {gameId === 'MATH' && <GameMath {...props} />}
                    </div>
                </div>
            );
        };

        const LeaderboardScreen = ({ onBack, currentName }) => {
            const [data, setData] = useState([]);
            useEffect(() => {
                const saved = localStorage.getItem('eventPlusLeaderboardAR');
                if (saved) setData(JSON.parse(saved));
            }, []);
            return (
                <div className="h-full flex flex-col p-6 relative overflow-hidden pb-16">
                     <div className="bg-game-deep"></div>
                     <div className="relative z-10 flex flex-col h-full max-w-2xl mx-auto w-full">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex flex-col">
                                <h2 className="text-3xl font-bold flex items-center gap-3"><Icon name="Trophy" className="text-yellow-400" /><span>ŸÑŸàÿ≠ÿ© ÿßŸÑÿµÿØÿßÿ±ÿ©</span></h2>
                                <span className="text-sm text-white/60 mt-1">ÿπÿØÿØ ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉŸäŸÜ: {data.length}</span>
                            </div>
                            <Button onClick={onBack} variant="ghost" className="p-2 rounded-full"><Icon name="X" /></Button>
                        </div>
                        <div className="flex-1 bg-slate-800/50 backdrop-blur-md rounded-2xl border border-white/10 overflow-hidden shadow-2xl relative">
                            <div className="overflow-y-auto max-h-[60vh] no-scrollbar pb-10">
                                {data.map((entry, idx) => (
                                    <div key={idx} className={`grid grid-cols-4 p-4 border-b border-white/5 items-center`}>
                                        <span className="font-bold text-yellow-400 text-center">#{idx+1}</span>
                                        <span className="col-span-2">{entry.name}</span>
                                        <span className="text-emerald-400 font-bold">{entry.score}</span>
                                    </div>
                                ))}
                            </div>
                            {data.length > 10 && (
                                <div className="absolute bottom-0 w-full bg-gradient-to-t from-black/80 to-transparent p-4 text-center text-xs text-white/50 animate-bounce">
                                    ÿ•ÿ≥ÿ≠ÿ® ŸÑÿ£ÿ≥ŸÅŸÑ ŸÑÿ±ÿ§Ÿäÿ© ÿßŸÑŸÖÿ≤ŸäÿØ
                                </div>
                            )}
                        </div>
                     </div>
                </div>
            );
        };

        const App = () => {
            const [screen, setScreen] = useState('START');
            const [name, setName] = useState('');
            const [diff, setDiff] = useState('MEDIUM');
            const [showKeyboard, setShowKeyboard] = useState(false);
            const [activeGame, setActiveGame] = useState(null);
            
            const [audioSettings, setAudioSettings] = useState({ musicOn: true, sfxOn: true });
            const [globalVolume, setGlobalVolume] = useState(0.5);
            const [showSettings, setShowSettings] = useState(false);

            useEffect(() => { AUDIO_SETTINGS.sfxOn = audioSettings.sfxOn; AUDIO_SETTINGS.musicOn = audioSettings.musicOn; }, [audioSettings]);

            const saveDataInternal = (finalScore) => {
                const sessionId = Date.now().toString();
                localStorage.setItem('currentSessionId', sessionId);
                const newEntry = { id: sessionId, name: name || "ŸÑÿßÿπÿ® ŸÖÿ¨ŸáŸàŸÑ", score: finalScore, date: new Date().toISOString() };
                const saved = localStorage.getItem('eventPlusLeaderboardAR');
                let list = saved ? JSON.parse(saved) : [];
                list.push(newEntry);
                list.sort((a, b) => b.score - a.score);
                list = list.slice(0, 50);
                localStorage.setItem('eventPlusLeaderboardAR', JSON.stringify(list));
            };

            const resetGame = () => { setScreen('START'); setName(''); };

            // --- BACKGROUND MANAGER ---
            const BackgroundLayer = useMemo(() => {
                // START & DIFFICULTY = HERO ORBS (Professional)
                if (screen === 'START' || screen === 'DIFFICULTY') {
                    return (
                        <div className="bg-hero-container">
                            <div className="hero-orb orb-1"></div>
                            <div className="hero-orb orb-2"></div>
                            <div className="hero-orb orb-3"></div>
                            <div className="bg-hero-grid opacity-30"></div>
                        </div>
                    );
                }
                // MENU = METEORS (Action)
                if (screen === 'MENU') {
                    return (
                        <div className="bg-meteor-container">
                            {[...Array(30)].map((_, i) => (
                                <div key={i} className="meteor" style={{
                                    left: `${Math.random() * 120 - 20}%`, top: `${Math.random() * 50}%`,
                                    animationDuration: `${Math.random() * 2 + 1}s`, animationDelay: `${Math.random() * 2}s`
                                }}></div>
                            ))}
                        </div>
                    );
                }
                // GAME = Deep Focus
                return (
                    <>
                        <div className="bg-game-deep transition-all duration-1000"></div>
                        {[...Array(15)].map((_, i) => (
                            <div key={i} className="particle" style={{
                                left: `${Math.random()*100}%`, top: `${Math.random()*100}%`,
                                width: `${Math.random()*10+2}px`, height: `${Math.random()*10+2}px`,
                                animationDelay: `${Math.random()*5}s`, animationDuration: `${Math.random()*10+10}s`
                            }}></div>
                        ))}
                    </>
                );
            }, [screen]);

            const handleGlobalClick = () => {
                const audio = document.getElementById('bgAudio');
                if(audio && audio.paused && audioSettings.musicOn) { audio.play().catch(e=>{}); }
            };

            return (
                <div className="h-full relative overflow-hidden" onClick={handleGlobalClick}>
                    {BackgroundLayer}
                    <div className="absolute inset-0 crt-scanline"></div>

                    {screen === 'START' && (
                        <div className="fixed top-4 left-4 z-50">
                            <button onClick={() => setShowSettings(true)} className="bg-white/10 hover:bg-white/20 p-3 rounded-full border border-white/20 backdrop-blur-md transition-all"><Icon name="Settings" size={24} /></button>
                        </div>
                    )}

                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} audioSettings={audioSettings} setAudioSettings={setAudioSettings} globalVolume={globalVolume} setGlobalVolume={setGlobalVolume} />

                    <MusicPlayer isInGame={screen === 'GAME'} volume={globalVolume} enabled={audioSettings.musicOn} />

                    {screen === 'START' && (
                        <div className={`h-full flex flex-col items-center justify-center p-6 text-center space-y-8 relative pb-16 z-10`}>
                             <div className="mb-8 relative flex justify-center animate-float">
                                <div className="absolute -inset-8 bg-purple-500 rounded-full blur-2xl opacity-20 animate-pulse"></div>
                                {/* --- HERO SVG --- */}
                                <svg viewBox="0 0 200 200" className="w-56 h-56 relative z-10 drop-shadow-[0_0_35px_rgba(139,92,246,0.6)]" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                        <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#c084fc"></stop><stop offset="50%" stopColor="#a855f7"></stop><stop offset="100%" stopColor="#6366f1"></stop></linearGradient>
                                        <filter id="neonGlow" height="300%" width="300%" x="-75%" y="-75%"><feGaussianBlur stdDeviation="5" result="coloredBlur"></feGaussianBlur><feMerge><feMergeNode in="coloredBlur"></feMergeNode><feMergeNode in="SourceGraphic"></feMergeNode></feMerge></filter>
                                    </defs>
                                    <path d="M100 10 L186.6 60 V160 L100 210 L13.4 160 V60 Z" fill="none" stroke="url(#logoGrad)" strokeWidth="4" opacity="0.3" transform="scale(0.9) translate(11,11)"></path>
                                    <path d="M100 25 L165 62.5 V137.5 L100 175 L35 137.5 V62.5 Z" fill="rgba(168, 85, 247, 0.1)" stroke="url(#logoGrad)" strokeWidth="6" strokeLinejoin="round" filter="url(#neonGlow)"></path>
                                    <circle cx="130" cy="100" r="12" fill="url(#logoGrad)" opacity="0.8"></circle>
                                    <circle cx="70" cy="100" r="12" fill="url(#logoGrad)" opacity="0.8"></circle>
                                    <circle cx="100" cy="70" r="8" fill="white" opacity="0.5"></circle>
                                    <path d="M100 110 L115 135 H85 Z" fill="white" opacity="0.9" filter="url(#neonGlow)"></path>
                                    <path d="M100 25 V45 M100 175 V155 M35 100 H55 M165 100 H145" stroke="white" strokeWidth="2" opacity="0.5" strokeLinecap="round"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 className="text-xl text-purple-300 tracking-[0.5em] uppercase mb-2">ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ™ÿ≠ÿØŸä</h2>
                                <h1 className="text-6xl font-black tracking-tighter">EVENT PLUS<br/><span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 drop-shadow-lg">GAMES</span></h1>
                            </div>
                            
                            {/* --- UNIFIED GLASS CONTAINER --- */}
                            <div className="glass-panel w-full max-w-sm rounded-3xl p-6 flex flex-col gap-4 shadow-2xl relative z-20">
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        placeholder="ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖŸÉ ŸÑŸÑŸÖŸÜÿßŸÅÿ≥ÿ©" 
                                        className="w-full glass-input rounded-xl p-4 text-center text-xl font-bold focus:outline-none placeholder:text-white/20" 
                                        value={name} 
                                        readOnly 
                                        onClick={() => setShowKeyboard(true)} 
                                    />
                                    {name && <Icon name="Check" className="absolute left-4 top-1/2 -translate-y-1/2 text-green-400" size={20} />}
                                </div>
                                <Button onClick={() => name && setScreen('DIFFICULTY')} disabled={!name} className={!name ? 'opacity-50 grayscale' : 'animate-pulse'}>
                                    <span className="ml-2">ÿßÿ®ÿØÿ£ ÿßŸÑÿ™ÿ≠ÿØŸä</span> <Icon name="ChevronLeft" />
                                </Button>
                                <Button variant="ghost" onClick={() => setScreen('LEADERBOARD')} className="text-sm">
                                    ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑÿµÿØÿßÿ±ÿ© <Icon name="Trophy" size={16} className="mr-2" />
                                </Button>
                            </div>

                            <VirtualKeyboard isVisible={showKeyboard} onChar={(c)=>setName(n=>n.length<15?n+(c===' '?' ':c):n)} onDelete={()=>setName(n=>n.slice(0,-1))} onEnter={()=>setShowKeyboard(false)} />
                        </div>
                    )}

                    {/* --- IMPROVED DIFFICULTY SCREEN --- */}
                    {screen === 'DIFFICULTY' && (
                        <div className={`h-full flex flex-col justify-center p-6 relative pb-16 z-10 max-w-md mx-auto w-full`}>
                            <h2 className="text-3xl font-bold text-center mb-8 drop-shadow-lg flex items-center justify-center gap-2">
                                <Icon name="BarChart2" className="text-purple-400" /> ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ
                            </h2>
                            <div className="flex flex-col gap-4">
                                {Object.values(DIFFICULTY_CONFIG).map((d) => (
                                    <button 
                                        key={d.id} 
                                        onClick={() => { setDiff(d.id); setScreen('MENU'); playSound('click'); }} 
                                        className={`group relative overflow-hidden rounded-2xl p-6 border transition-all duration-300 transform hover:scale-[1.02] hover:shadow-2xl text-right bg-white/5 backdrop-blur-md ${d.border} ${d.glow}`}
                                    >
                                        <div className={`absolute inset-0 bg-gradient-to-r ${d.bgGradient} opacity-0 group-hover:opacity-100 transition-opacity duration-500`}></div>
                                        <div className="relative z-10 flex justify-between items-center">
                                            <div>
                                                <h3 className={`text-3xl font-black italic mb-1 ${d.color}`}>{d.label}</h3>
                                                <p className="text-xs text-white/50 font-medium tracking-wide">{d.subLabel}</p>
                                            </div>
                                            <div className={`p-3 rounded-xl bg-white/5 border border-white/10 group-hover:bg-white/10 transition-colors ${d.color}`}>
                                                <Icon name={d.icon} size={32} />
                                            </div>
                                        </div>
                                        <div className="mt-4 flex gap-2">
                                            <span className="text-[10px] bg-black/40 px-2 py-1 rounded border border-white/5 text-white/70">ÿ≥ÿ±ÿπÿ© {Math.floor(d.speedFactor*100)}%</span>
                                            <span className="text-[10px] bg-black/40 px-2 py-1 rounded border border-white/5 text-white/70">ŸÜŸÇÿßÿ∑ x{d.multiplier}</span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                            <Button variant="ghost" className="mt-8 mx-auto w-12 h-12 rounded-full border border-white/10" onClick={() => setScreen('START')}><Icon name="ArrowRight" /></Button>
                        </div>
                    )}

                    {/* --- NEW PROFESSIONAL MENU SCREEN --- */}
                    {screen === 'MENU' && (
                        <div className="h-full flex flex-col p-6 pb-20 z-10 w-full max-w-4xl mx-auto">
                            {/* Header Section */}
                            <div className="flex flex-col items-center mb-8 animate-slideDown">
                                <div className="bg-white/5 border border-white/10 px-6 py-2 rounded-full backdrop-blur-md mb-4 flex items-center gap-2 shadow-lg">
                                    <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                    <span className="text-sm text-white/60">ÿßŸÑŸÑÿßÿπÿ®:</span>
                                    <span className="text-lg font-bold text-purple-400">{name}</span>
                                </div>
                                <h2 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-white/60 drop-shadow-sm">
                                    ÿßÿÆÿ™ÿ± ŸÑÿπÿ®ÿ™ŸÉ
                                </h2>
                            </div>

                            {/* Games Grid - Adjusted Spacing (Gap-8) */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full flex-1 content-center overflow-y-auto no-scrollbar pb-10">
                                {GAMES_LIST.map((g, i) => (
                                    <button
                                        key={g.id}
                                        onClick={() => { setActiveGame(g.id); setScreen('GAME'); playSound('click'); }}
                                        className={`group relative overflow-hidden rounded-3xl p-1 border border-white/10 transition-all duration-300 hover:scale-[1.02] hover:shadow-[0_0_30px_rgba(168,85,247,0.15)] h-auto min-h-[120px] md:min-h-[160px] flex-1`}
                                        style={{animationDelay: `${i * 100}ms`}}
                                    >
                                        {/* Card Interior */}
                                        <div className="absolute inset-0 bg-[#1a103c] rounded-[22px] z-0"></div>
                                        <div className={`absolute inset-0 bg-gradient-to-br ${g.color} opacity-0 group-hover:opacity-20 transition-opacity duration-500 z-0`}></div>

                                        {/* Added gap-8 for clear spacing */}
                                        <div className="relative z-10 flex items-center justify-start p-6 h-full bg-white/5 rounded-[22px] backdrop-blur-sm overflow-hidden gap-8">
                                            {/* Decorative Circle Background */}
                                            <div className={`absolute -right-6 -bottom-6 w-32 h-32 rounded-full bg-gradient-to-br ${g.color} opacity-20 blur-xl group-hover:opacity-40 transition-all`}></div>

                                            {/* Icon */}
                                            <div className={`w-20 h-20 rounded-2xl flex items-center justify-center bg-gradient-to-br ${g.color} shadow-lg group-hover:scale-110 transition-transform duration-300 shrink-0`}>
                                                <Icon name={g.icon} size={40} className="text-white" />
                                            </div>

                                            {/* Text Info */}
                                            <div className="flex flex-col items-start text-right flex-1">
                                                <h3 className="text-2xl md:text-3xl font-bold text-white mb-2 group-hover:text-purple-200 transition-colors">{g.name}</h3>
                                                <p className="text-sm md:text-base text-white/50 font-medium leading-tight">{g.desc}</p>
                                            </div>

                                            {/* Arrow Indicator */}
                                            <div className="absolute top-1/2 left-6 -translate-y-1/2 opacity-0 -translate-x-4 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300">
                                                <Icon name="ChevronLeft" size={24} className="text-white/50" />
                                            </div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                            
                             <div className="mt-auto flex justify-center pt-4">
                                 <Button variant="ghost" onClick={() => setScreen('DIFFICULTY')} className="text-sm opacity-50 hover:opacity-100">
                                     <Icon name="ArrowRight" size={16} className="ml-2" /> ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ
                                 </Button>
                            </div>
                        </div>
                    )}

                    {screen === 'GAME' && (
                        <div className={`h-full z-10 relative`}>
                            <GameEngine gameId={activeGame} difficulty={diff} onExit={() => setScreen('MENU')} onAutoSave={saveDataInternal} onViewLeaderboard={() => setScreen('LEADERBOARD')} onHome={resetGame} volume={globalVolume} onOpenSettings={() => setShowSettings(true)} />
                        </div>
                    )}

                    {screen === 'LEADERBOARD' && <LeaderboardScreen onBack={resetGame} currentName={name} />}
                    
                    <CopyrightBadge />
                    <Footer />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
